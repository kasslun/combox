/**
 * 作者: Jason.wang
 * 日期: 13-10-9
 * 描述: A javascript combox
 */
!function(t){function e(t){var e,i,s,n={}
    for(e in o)i=t[e],s=o[e],n[e]=i&&(h.type(o[e])===h.type(t[e])||null===o[e]&&"function"==typeof t[e])?t[e]:o[e]
    return"100%"===t.width&&(n.width="100%"),n.datasource=t.datasource,n}function i(t,i){this.options=e(t),this.$el=i}function s(t,i){this.options=e(t),this.$el=i}var o,n,h=t.$
    h.combox||(o={emptyText:"请选择",value:"",readonly:!1,width:200,height:200,mode:"Single",datasource:null,name:"",select:-1,valueField:"value",textField:"text",onChange:null},t.jQuery.fn.combox=function(t){var e,o
        if(this.length)return this.data("gridObj")?this.data("gridObj"):(o=t.mode,e="Multi"===o||"multi"===o?new s(t,this):new i(t,this),this.data("gridObj",e),e._init(),e)},n={_init:function(){var e=this.options,i=h("head").eq(0)
        this.$el.addClass("combox-main").css("width",e.width),this.text="",this.value="",this.valueCache="",this.isHide=!0,i.attr("style","*font-family:isIE7;_font-family:isIE6;"),this[i.css("font-family")||"notIE6-7"]=!0,i.removeAttr("style"),this.top=t.location===t.parent.location,this.eqEmptyText=!1,this.rendered=!1,this.oldData=null,this.position={},this._initWidthAndHeight(e.width,e.height),this._create()},_initWidthAndHeight:function(t,e){var i=this.options
        "number"==typeof t&&(i.width=t+"px"),e&&(this.height=e-2,i.height=this.height+"px")},_create:function(){this._createDom(),this._bindFocusBlurEvent(),this._bindMouseEvent(),this._bindKeyEvent(),this._resetLayoutEvent(),this._initData(),this.setReadonly(this.options.readonly)},_createDom:function(){var t,e,i=this.options,s=this.$el,o=""
        t=['<div class="combox-inner combox-readonly">','<input class="combox-text" readonly="readonly" type="text" autocomplete="off" value="',i.emptyText,'" />','<a href="javascript:;" hidefocus="true" class="combox-btn combox-loading"></a>',"</div>",'<input type="hidden" class="combox-hidden" name="',i.name,'" />'],s.html(t.join("")),e=h(document.createElement("div")).addClass("combox-box"),this.isIE6&&(o='<iframe scrolling="no" frameborder="no"></iframe>'),e.html(o+'<div class="combox-box-inner"></div>'),h("body").append(e),this.$inner=s.find(".combox-inner").eq(0),this.$text=s.find(".combox-text").eq(0),this.$btn=s.find(".combox-btn").eq(0),this.$hide=s.find(".combox-hidden").eq(0),this.$box=e,this.$boxInner=e.find(".combox-box-inner").eq(0)},_bindFocusBlurEvent:function(){var t=this
        this.$text.on("focus",function(){t._showBox()}).on("blur",function(){t._hideBox()}).on("beforedeactivate",function(){return t.hideAble})},_showBox:function(){var t=this.$el[0].getBoundingClientRect()
        this.position.top=t.top,this.position.left=t.left,this.isHide!==!1&&(this.isHide=!1,this._setBoxLayout(this._setBoxPosition(t)),this.listenPosition(),this._isEmpty(),this.rendered?(this.setOldData(),this.$inner.addClass("combox-inner-focus"),this.__showBoxCallBack&&this.__showBoxCallBack()):this._callDataSource())},listenPosition:function(){var t=this,e=t.$el[0]
        clearInterval(this.listenBoxPostion),this.listenBoxPostion=setInterval(function(){var i=e.getBoundingClientRect(),s=t.position;(i.left!==s.left||i.top!==s.top)&&t.$text.blur()},10)},_callDataSource:function(){this.dataCalling||(this.$btn.addClass("combox-loading"),this.options.datasource(this),this.dataCalling=!0)},_isEmpty:function(){var t,e,i,s=this.$text
        if(this.rendered&&(this.eqEmptyText||this._isEqEmptyText()))return s.addClass("combox-text-value"),void 0
        switch(t=s.val(),e=this.isHide,i=this.options.emptyText,t){case"":e&&s.val(i).removeClass("combox-text-value")
            break
            case i:e||s.val("").addClass("combox-text-value")
                break
            default:s.addClass("combox-text-value")}},_isEqEmptyText:function(){for(var t=this.data,e=t.length,i=this.options,s=i.emptyText,o=i.textField,n=0;e>n;n++)if(s===t[n][o])return this.eqEmptyText=!0,!0
        return!1},_setBoxPosition:function(t){var e=28,i=2,s=10,o=h(o),n=h("html")[0],a=h("body")[0],l=t.left+o.scrollLeft(),r=this._getRealHeight(),c=r+e+i,d=t.top+o.scrollTop()+e
        return d>Math.max.apply(null,[n.clientHeight&&n.scrollHeight,a.clientHeight,a.scrollHeight,n.clientHeight])-r-s&&d>r+e&&(d-=c),this.$box.css((this.isIE6||this.isIE7)&&this.top?{left:l-2,top:d-2}:{left:l,top:d}),r},_getRealHeight:function(){return Math.min(this.height,this.$boxInner.css("height","auto").outerHeight()||28)},_setBoxLayout:function(t){this.$box.css({height:t,width:this.$el.width()-2})},_hideBox:function(){if(this.isHide!==!0){if(this.hideAble===!1)return this.$text.focus(),void 0
        this.isHide=!0,this.$box.css("top","-999999px"),clearInterval(this.listenBoxPostion),this.$inner.removeClass("combox-inner-focus"),this.rendered?(this.__hideBoxCallBack&&this.__hideBoxCallBack(),this._triggerChange(!1)):this._isEmpty()}},setOldData:function(){var t=this.selectData,e=h.type(t)
        this.valueCache=this.value,this.oldData="array"===e?h.extend(!0,[],t):"object"===e?h.extend(!0,{},t):null},_triggerChange:function(t){var e
        this.valueCache===this.value||t||(e=this.options.onChange,"function"==typeof e&&e(this.selectData,this.oldData))},_bindMouseEvent:function(){var e=this,i=this.$text,s=function(i){t.event?e.hideAble=!1:i.preventDefault(),i.stopPropagation()}
        this.$btn.on("mouseup",function(){e.readonly||(e.isHide?i.focus():(e.hideAble=!0,i.blur()))}).on("mousedown",s),this.$box.on("mouseup",function(t){t.stopPropagation(),e.hideAble=!0,e.__mouseUpHandler(t)}).on("mousedown",s)},_bindKeyEvent:function(){var t,e=this
        this.$text.on("keydown",function(i){switch(t=i.keyCode){case 8:i.preventDefault()
            break
            case 38:e.__keyDownUPHandler&&e.__keyDownUPHandler()
                break
            case 40:e.__keyDownDownHandler&&e.__keyDownDownHandler()
                break
            case 37:e.__keyDownLeftHandler&&e.__keyDownLeftHandler()
                break
            case 39:e.__keyDownRightHandler&&e.__keyDownRightHandler()
                break
            case 13:e.__keyDownEnterHandler&&e.__keyDownEnterHandler()
                break
            default:e.__keyDownHandler&&e.__keyDownHandler()}})},_resetLayoutEvent:function(){var e=this,i=this.$el[0]
        h(t).on("resize scroll",function(){var t,s
            e.isHide||(t=i.getBoundingClientRect(),s=e.position,(t.left!==s.left||t.top!==s.top)&&e.$text.blur())})},_initData:function(){var t,e,i=this.options
        t=i.datasource,e=h.type(t),"function"===e?""!==i.value||-1!==i.select?this._callDataSource():this.$btn.removeClass("combox-loading"):"array"===e?this.setDatasource(t):this.setDatasource([])},setDatasource:function(t){var e,i,s,o=this.options
        return this.data=h.extend(!0,[],t),this.$btn.removeClass("combox-loading"),e=this.rendered,this.__initMode(e),e?this._emptyStat():(this.rendered=!0,s=o.value,i=o.select,s?this.setVal(s,!0):i>-1&&i<t.length&&this.setVal(t[i][o.valueField],!0)),this.isHide||this._setBoxLayout(this._setBoxPosition(this.$el[0].getBoundingClientRect())),this},setDataSource:function(t){return this.setDatasource(t)},_emptyStat:function(){this.text="",this.value="",this.valueCache="",this.selectData=null,this.$text.val(""),this.$hide.val(""),this.eqEmptyText=!1,this._isEmpty()},_setProp:function(t){var e=t.text,i=t.value||e,s=t.data
        this.text=e,this.value=i,this.selectData=s,this.$text.val(e),this.$hide.val(i),this._isEmpty()},open:function(){return this.$text.focus(),this},setWidth:function(t){var e=this.options
        return"string"==typeof t&&/%/.test(t)?e.width=t:this._initWidthAndHeight(t+""),this.$text.blur(),this.$el.css("width",e.width),this},setVal:function(t,e){return this.rendered?(this.setOldData(),this.__setVal(void 0===t?this.options.value:t),this._triggerChange(e)):(this.options.value=t,this.$hide.val(t),this._callDataSource()),this},getVal:function(){return this.rendered?this.value:this.options.value},getData:function(){var t=this.selectData,e=h.type(t)
        switch(e){case"array":return h.extend(!0,[],this.selectData)
            case"object":return h.extend(!0,{},this.selectData)
            default:return null}},getText:function(){return this.__getText()},setReadonly:function(t){return t===!0?(this.readonly=!0,this.$inner.addClass("combox-readonly"),this.$text.attr("disabled","disabled"),this.$text.blur()):t===!1&&(this.readonly=!1,this.$inner.removeClass("combox-readonly"),this.$text.removeAttr("disabled")),this}},i.prototype=h.extend({__initMode:function(t){this.index=-1,t?this.$hideListBox.html(""):this.$hideListBox=h(document.createElement("div")),this.__createList()},__createList:function(){var t,e,i,s,o,n,h=this.$boxInner,a=this.data,l=this.size=a.length,r=[],c=this.options.textField
        for(t=0;l>t;t++)n=a[t][c],r.push('<a class="combox-list" href="javascript:;" index="',t,'" title="',n,'">',n,"</a>")
        for(h.html(r.join("")),i=h.find(".combox-list"),s=this.list=[],o=this.indexList=[],e=0;l>e;e++)s[e]=i.eq(e),o[e]=e},__getIndex:function(t,e){var i,s=this.options,o=t||e,n=s.valueField,h=this.data,a=this.size
        for(void 0===t&&(n=s.textField),i=0;a>i;i++)if(h[i][n]===o+"")return i
        return-1},__showBoxCallBack:function(){var t=this.index;-1!==t&&this.__scrollHoverPosition(t)},__hideBoxCallBack:function(){this.selectEvent=!1,this.__recoverBox(),this.__clearHover()},__clearHover:function(){var t=this.hoverIndex
        void 0!==t&&(this.list[this.indexList[t]].removeClass("combox-hover"),delete this.hoverIndex)},__recoverBox:function(){var t,e=this.list,i=this.indexList=[],s=this.size,o=this.$boxInner
        for(t=0;s>t;t++)o.find(e[t]).length||o.append(e[t]),i.push(t)},__setVal:function(t){this.__checkSelect(this.__getIndex(t))},__checkSelect:function(t){var e,i=this.options,s=i.textField,o=i.valueField,n=this.list,h=this.index;-1!==h&&n[h].removeClass("combox-checked"),-1!==t?(n[t].addClass("combox-checked"),e=this.data[t],this._setProp({text:e[s],value:e[o],data:e})):this._setProp({value:"",text:this.$text.val(),data:null}),this.index=t},__mouseUpHandler:function(t){var e,i=h(t.target)
        this.selectEvent=!0,i.hasClass("combox-list")?(e=i.attr("index"),e&&this.__checkSelect(e-0),this.$text.blur()):this.size||this.$text.blur()},__keyDownUPHandler:function(){var t,e,i=this.indexList,s=i.length
        s&&(t=this.list,e=this.hoverIndex,void 0===e?(e=s-1,t[i[e]].addClass("combox-hover")):(t[i[e]||0].removeClass("combox-hover"),-1===--e&&(e=s-1),t[i[e]].addClass("combox-hover")),this.hoverIndex=e,this.__scrollHoverPosition(e))},__keyDownDownHandler:function(){var t,e,i=this.indexList,s=i.length
        s&&(t=this.list,e=this.hoverIndex,void 0===e?(e=0,t[i[0]].addClass("combox-hover")):(t[i[e]||0].removeClass("combox-hover"),s===++e&&(e=0),t[i[e]].addClass("combox-hover")),this.hoverIndex=e,this.__scrollHoverPosition(e))},__scrollHoverPosition:function(t){var e=28,i=this.$box,s=t*e,o=s+e-i.height()
        i.scrollTop()<o?i.scrollTop(o):i.scrollTop()>s&&i.scrollTop(s)},__keyDownEnterHandler:function(){var t=this.hoverIndex
        this.selectEvent=!0,void 0!==t&&this.__checkSelect(this.indexList[t]),this.$text.blur()},__getText:function(){return this.text}},n),s.prototype=h.extend({__initMode:function(t){this.index=[],this.checkAll=!1,this.__createList(t)},__createList:function(t){var e,i,s,o,n,h,a=this.data,l=this.$box,r=this.size=a.length,c=[],d=this.options.textField
        for(e=0;r>e;e++)h=a[e][d],c.push('<a class="combox-list" href="javascript:;" index="',e,'" title="',h,'">',h,"</a>")
        for(t?this.__setAllCheck(!1):(l.addClass("multi-combox-box").append('<div class="combox-list-all"><a href="javascript:;" class="combox-list">全选</a></div>'),this.allCheckDom=l.find(".combox-list-all").eq(0).find(".combox-list").eq(0),this.__bindAllAcitveEvent()),r?l.find(".combox-list-all").eq(0).show():l.find(".combox-list-all").eq(0).hide(),s=this.$boxInner.html(c.join("")).find(".combox-list"),o=this.list=[],n=this.indexList=[],i=0;r>i;i++)o[i]=s.eq(i),n[i]=i},__bindAllAcitveEvent:function(){var t,e,i=this
        this.allCheckDom.on("click",function(s){if(s.stopPropagation(),i.checkAll)i.index=[]
        else{for(t=[],e=i.size;e--;)t[e]=!0
            i.index=t}i.__setInputProp()})},__setAllCheck:function(t){var e="全选",i="取消"
        this.checkAll=t,t?this.allCheckDom.addClass("combox-checked").html(i):this.allCheckDom.removeClass("combox-checked").html(e)},__showBoxCallBack:function(){var t=this.index,e=t.length,i=0
        if(e){for(;e>i;i++)if(t[i]===!0){this.__scrollHoverPosition(i)
            break}}else this.__scrollHoverPosition(0)},__hideBoxCallBack:function(){this.__clearHover()},__setIndex:function(t,e){var i,s,o,n,h,a,l=this.options,r=l.valueField,c=void 0===t?e:t
        if("string"==typeof c){for(i=this.index=[],s=this.data,o=this.size,void 0===t&&(r=l.textField),c=c.split(/,|，/),a=c.length,n=0;o>n;n++)for(h=0;a>h;h++)s[n][r]===c[h]&&(i[n]=!0)
            this.__setInputProp()}},__setInputProp:function(){var t,e,i=this.options,s=i.textField,o=i.valueField,n=this.size,h=this.data,a=this.index,l=this.list,r=0,c=[],d=[],u=[]
        for(e=0;n>e;e++)t=h[e],a[e]?(r++,l[e].addClass("combox-checked"),c.push(t[s]),d.push(t[o]),u.push(t)):l[e].removeClass("combox-checked")
        this.__setAllCheck(r===n&&0!==n),this._setProp({text:c.join(","),value:d.join(","),data:u})},__clearHover:i.prototype.__clearHover,__setVal:function(t){this.__setIndex(t)},__checkSelect:function(t){var e=this.index
        0>t||t>=this.size||(e[t]=!e[t],this.__setInputProp())},__mouseUpHandler:function(t){var e,i=h(t.target)
        i.hasClass("combox-list")&&(e=i.attr("index"),e&&this.__checkSelect(e-0)),this.$text.focus()},__keyDownUPHandler:i.prototype.__keyDownUPHandler,__keyDownDownHandler:i.prototype.__keyDownDownHandler,__scrollHoverPosition:function(t){var e=28,i=this.$box,s=t*e,o=s+2*e-i.height()
        i.scrollTop()<o?i.scrollTop(o):i.scrollTop()>s&&i.scrollTop(s)},__keyDownEnterHandler:function(){var t=this.hoverIndex
        void 0!==t&&this.__checkSelect(this.indexList[t])},__getText:function(){return""===this.text?[]:this.text.split(",")}},n))}(window)